version: "3.8"

services:
  # ===== Auth Service =====
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-local}/auth-service:${IMAGE_TAG:-latest}
    container_name: auth-service
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8081}:8081"
    environment:
      # Spring Profiles
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}

      # Database Configuration
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver

      # JPA Configuration
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQL10Dialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${DDL_AUTO:-validate}
      - SPRING_JPA_SHOW_SQL=${SHOW_SQL:-false}
      - SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=${FORMAT_SQL:-false}

      # Google OAuth2 Configuration
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE=${GOOGLE_OAUTH_SCOPE:-email,profile}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-http://localhost:8081/login/oauth2/code/google}

      # JWT Configuration
      - JWT_PRIVATE_KEY=${JWT_PRIVATE_KEY:-classpath:keys/private_key.pem}
      - JWT_PUBLIC_KEY=${JWT_PUBLIC_KEY:-classpath:keys/public_key.pem}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}

      # OAuth2 Redirect Configuration
      - APP_OAUTH2_AUTHORIZED_REDIRECT_URI=${OAUTH2_REDIRECT_URI:-http://localhost:5173/oauth2/redirect}

      # Server Configuration
      - SERVER_PORT=8081
      - SERVER_SERVLET_CONTEXT_PATH=${CONTEXT_PATH:-}

      # Logging Configuration
      - LOGGING_LEVEL_ROOT=${LOG_LEVEL:-INFO}
      - LOGGING_LEVEL_COM_SPORTSCHAOS_AUTH_SERVICE=${APP_LOG_LEVEL:-INFO}
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY=${SECURITY_LOG_LEVEL:-INFO}
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=${WEB_LOG_LEVEL:-INFO}

    networks:
      - auth-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8081/actuator/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  auth-network:
    driver: bridge
